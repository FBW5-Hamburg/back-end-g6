<!DOCTYPE html>
<html lang="en">
    <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Font Awesome -->
    <link
        rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css"
        integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk="
        crossorigin="anonymous"
    />
    <!-- CSS -->
    <link rel="stylesheet" href="/css/style.css" />
    <title>ChatApp</title>
    </head>
    <body>
    <div class="chat-container">
        <header class="chat-header">
            <!-- <h1><i class="fas fa-smile"></i> ChatCord</h1> -->
            <h1>ChatApp</h1>
            <h2 class="room-name"></h2>
            <button class="btn"><i class="fas fa-times"></i></button>
        </header>
        <main class="chat-main">
            <div class="chat-sidebar">
                <h3><i class="fas fa-comments"></i> Room</h3>
                <h2 class="room-name"></h2>
                <h3><i class="fas fa-users"></i> Users</h3>
                <ul id="users"></ul>
            </div>
            <div class="chat-messages"></div>
        </main>
        <div class="chat-form-container">
            <nav>
                 <!-- <button class="btn"><i class="fas fa-file"></i></button> -->
                <label for="images">
                   <button class="btn"><i class="fas fa-file-image"></i></button>
                   <input type="file" id="image-upload" accept="image/x-png,image/gif,image/jpeg" />
                </label>
                <button class="btn"><i class="fas fa-arrow-alt-circle-right"></i></button>
            </nav>
            <form id="chat-form">
                <input id="msg" type="text" class="emoji" placeholder="Enter Message" required autocomplete="off"/>
                <button class="btn"><i class="fas fa-paper-plane"></i></button>
            </form>
        </div>
    </div>
    <script
        src="https://cdnjs.cloudflare.com/ajax/libs/qs/6.9.2/qs.min.js"
        integrity="sha256-TDxXjkAUay70ae/QJBEpGKkpVslXaHHayklIVglFRT4="
        crossorigin="anonymous"
    ></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="/js/emojiPicker.js"></script>
    <script>
        //emoji.initiate();
        const chatForm = document.getElementById('chat-form');
        const chatMessages = document.querySelector('.chat-messages');
        const roomName = document.getElementsByClassName('room-name');
        const userList = document.getElementById('users');

        console.log(roomName);

        // Output old messages
        const oldmessages = '<%-oldMessages%>';
        const oldMessagesObj = JSON.parse(oldmessages)
        oldMessagesObj.forEach(element => {
            outputMessage(element)
        });

        // upload images
        document.querySelector('label > button').addEventListener('click', e => {
            e.preventDefault();
            // get file input for images
            const imgsInp = document.getElementById('image-upload')
            // activate file input
            imgsInp.click();
            // get image files
            imgsInp.addEventListener('change', e => {
                // create file reader object
                const msg = new FileReader();
                // check file size
                if(msg && msg.size < (6 * 1024 * 1024)) { // 6 MB
                    // get image name
                    const filename = e.target.files[0].name;
                    // will be executed when the file finished uploading
                    msg.onload = e => {
                        // this will take each part of the image
                    const base64 = e.target.result.replace(/.*base64,/, '');
                        // sent to server
                        socket.emit('image',{base64, filename});
                    }
                    // read image and divide it in many parts
                    msg.readAsDataURL(e.target.files[0]);
                } else {
                    //Prevent default and display error
                    e.preventDefault();
                    alert('Only a maximal size of 6 MB is allowed.')
                }
            }, false);
            return
        });
        // Get username and room from URL
        // const { username, room } = Qs.parse(location.search, {
        //   ignoreQueryPrefix: true
        // });

        const username = '<%=username%>'
        const room = '<%=chatRoom%>'

        const socket = io();

        // Join chatroom
        socket.emit('joinRoom', {username, room});

        // Get room and users
        socket.on('roomUsers', ({room, users}) => {
            outputRoomName(room);
            outputUsers(users);
        });

        // Message from server
        socket.on('message', message => {
            console.log(message);
            outputMessage(message);
            
            // Scroll down
            chatMessages.scrollTop = chatMessages.scrollHeight;
        });

        // submit text message
        chatForm.addEventListener('submit', e => {
            e.preventDefault();
            // get text message
            const msg = e.target.elements.msg.value;
            // send out text message to server
            socket.emit('chatMessage', msg);
            // clear input
            e.target.elements.msg.value = '';
            e.target.elements.msg.focus();
        });

        // Output message to DOM
        function outputMessage(message) {
            const div = document.createElement('div');
            div.classList.add('message');
            //
            if (message.text.startsWith("/upload")) {
                div.innerHTML = `<p class="meta">${message.username} <span>${message.time}</span></p><image id="image" src="${message.text}" />`;
            } else {
                div.innerHTML = `<p class="meta">${message.username} <span>${message.time}</span></p><p class="text">${message.text}</p>`;
            };
            document.querySelector('.chat-messages').appendChild(div);
        };

        // Add room name to DOM
        function outputRoomName(room) {
            for(let i = 0; i < roomName.length; i++) {
                roomName[i].innerText = room;
            };
        };

        // Add users to DOM
        function outputUsers(users) {
            userList.innerHTML = `${users.map(user => `<li>${user.username}</li>`).join('')}`;
        };
        // leave room
        document.querySelector('nav > .btn:last-child').addEventListener('click', e => {
            e.preventDefault();
            window.location = '/room';
        });
        // logout
        document.querySelector('header > .btn').addEventListener('click', e => {
            e.preventDefault();
            window.location = '/logout';
        });
    </script>
    </body>
</html>
